<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USJ 챗봇 MRK6</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* PC 버전 기본 스타일 */
        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 80vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .chat-header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .chat-header .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message.user { align-items: flex-end; }
        .message.bot { align-items: flex-start; }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .message.user .message-content {
            background: #007bff;
            color: white;
        }
        
        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
        }
        
        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }
        
        .chat-input-row {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
        }
        
        .send-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .quick-questions {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            min-width: fit-content;
            transition: background-color 0.2s;
        }
        
        .quick-btn:hover {
            background: #e9ecef;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        /* 모바일 전용 스타일 */
        @media (max-width: 768px) {
            body {
                padding: 0;
                align-items: stretch;
                overflow: hidden;
            }
            
            .chat-container {
                width: 100%;
                height: 100vh;
                height: 100dvh; /* 동적 뷰포트 높이 */
                border-radius: 0;
                max-width: none;
                box-shadow: none;
                position: relative;
            }
            
            .chat-header {
                padding: 15px 20px;
                position: relative;
                flex-shrink: 0;
            }
            
            .chat-header h1 {
                font-size: 1.3rem;
            }
            
            .chat-header .subtitle {
                font-size: 0.8rem;
            }
            
            .chat-messages {
                flex: 1;
                padding: 15px;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch; /* iOS 부드러운 스크롤 */
                scroll-behavior: smooth;
                /* 스크롤 바운스 방지 */
                overscroll-behavior: contain;
            }
            
            .message-content {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            
            .chat-input-container {
                padding: 15px;
                flex-shrink: 0;
                position: relative;
                background: white;
                border-top: 2px solid #e9ecef;
                /* 키보드 영역 침범 방지 */
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
            
            .quick-questions {
                gap: 6px;
                margin-bottom: 12px;
            }
            
            .quick-btn {
                padding: 10px 12px;
                font-size: 0.75rem;
                border-radius: 20px;
                /* 모바일에서 긴 텍스트는 줄바꿈 허용 */
                white-space: normal;
                text-align: center;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex: 1;
                min-width: 0;
            }
            
            .chat-input {
                padding: 14px 16px;
                font-size: 16px; /* iOS 줌 방지 */
                border-radius: 20px;
            }
            
            .send-btn {
                padding: 14px 20px;
                font-size: 0.9rem;
                border-radius: 20px;
                min-width: 60px;
            }
            
            .chat-input-row {
                gap: 8px;
            }
        }
        
        /* 아주 작은 모바일 (iPhone SE 등) */
        @media (max-width: 375px) {
            .chat-header {
                padding: 12px 15px;
            }
            
            .chat-header h1 {
                font-size: 1.2rem;
            }
            
            .chat-messages {
                padding: 12px;
            }
            
            .chat-input-container {
                padding: 12px;
            }
            
            .quick-btn {
                font-size: 0.7rem;
                padding: 8px 10px;
                min-height: 36px;
            }
            
            .send-btn {
                padding: 12px 16px;
                min-width: 55px;
            }
        }
        
        /* 태블릿 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .chat-container {
                width: 85%;
                max-width: 700px;
            }
            
            .quick-btn {
                font-size: 0.85rem;
            }
        }
        
        /* 스크롤바 스타일링 (webkit 브라우저) */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>🎢 USJ 챗봇 MRK6</h1>
            <div class="subtitle">유니버셜스튜디오 재팬 전문 상담</div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-content">
                    안녕하세요! USJ 전문 상담 챗봇입니다.<br>
                    티켓 예약, 익스프레스패스, 어트랙션 정보 등을 도움드려요!
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="quick-questions">
                <!-- 질문들이 JavaScript로 동적 생성됩니다 -->
            </div>
            
            <div class="chat-input-row">
                <input type="text" class="chat-input" id="messageInput" 
                       placeholder="USJ 관련 질문을 입력하세요..." 
                       onkeypress="handleEnter(event)">
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">전송</button>
            </div>
        </div>
    </div>

    <script>
        // 디바이스 감지
        function isMobile() {
            return window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // 심플한 설정
        const API_URL = 'https://usj-chatbot.run.goorm.site';
        let chatId = 'user_' + Date.now();
        let isProcessing = false;
        let shouldAutoScroll = true; // 자동 스크롤 제어 변수
        
        // USJ 질문 배열 (TXT 파일에서 로드될 예정)
        let usjQuestions = [];
        let currentQuestions = [];
        
        // TXT 파일에서 질문 로드
        async function loadQuestions() {
            try {
                const response = await fetch('./USJ_Q.TXT');
                const text = await response.text();
                usjQuestions = text.split('\n')
                    .map(q => q.trim())
                    .filter(q => q.length > 0);
                
                // 초기 질문 설정
                updateQuickQuestions();
            } catch (error) {
                console.error('질문 파일 로드 실패:', error);
                // 기본 질문으로 폴백
                usjQuestions = [
                    "USJ 입장 시 캐리어를 맡길 수 있는 곳이 있나요?",
                    "USJ에서 당일 입장권도 구매할 수 있나요?"
                ];
                updateQuickQuestions();
            }
        }
        
        // 키워드 매칭을 위한 간단한 함수
        function getKeywordsFromMessage(message) {
            const keywords = [];
            const text = message.toLowerCase();
            
            // 주요 키워드 추출
            const keywordMap = {
                "마리오": ["마리오", "닌텐도", "nintendo", "카트"],
                "캐리어": ["캐리어", "짐", "수하물", "보관"],
                "해리포터": ["해리포터", "포터", "마법"],
                "어린이": ["어린이", "아이", "아기", "유아"],
                "식당": ["식당", "음식", "식사", "레스토랑"],
                "입장권": ["입장권", "티켓", "패스"],
                "교통": ["교통", "지하철", "역", "이동"],
                "익스프레스": ["익스프레스", "express"],
                "촬영": ["촬영", "사진", "카메라"],
                "퍼레이드": ["퍼레이드", "쇼", "공연"],
                "대기": ["대기", "줄", "기다리"],
                "앱": ["앱", "어플"],
                "호텔": ["호텔", "숙소"],
                "비": ["비", "우천", "날씨"],
                "할인": ["할인", "외국인"],
                "시간": ["시간", "운영", "개장"]
            };
            
            for (const [key, values] of Object.entries(keywordMap)) {
                if (values.some(v => text.includes(v))) {
                    keywords.push(key);
                }
            }
            
            return keywords;
        }
        
        // 관련 질문 찾기 함수
        function getRelatedQuestions(userMessage, count = 2) {
            if (usjQuestions.length === 0) return [];
            
            const keywords = getKeywordsFromMessage(userMessage);
            const relatedQuestions = [];
            
            // 키워드 기반으로 관련 질문 찾기
            for (const question of usjQuestions) {
                for (const keyword of keywords) {
                    if (question.toLowerCase().includes(keyword) && 
                        !relatedQuestions.includes(question) &&
                        question !== userMessage) {
                        relatedQuestions.push(question);
                        break;
                    }
                }
            }
            
            // 관련 질문이 충분하지 않으면 랜덤으로 채우기
            if (relatedQuestions.length < count) {
                const remainingNeeded = count - relatedQuestions.length;
                const randomQuestions = getRandomQuestions(remainingNeeded * 2, relatedQuestions.concat([userMessage]));
                relatedQuestions.push(...randomQuestions.slice(0, remainingNeeded));
            }
            
            return relatedQuestions.slice(0, count);
        }
        
        // 랜덤 질문 선택 함수
        function getRandomQuestions(count = 2, excludeQuestions = []) {
            if (usjQuestions.length === 0) return [];
            
            const availableQuestions = usjQuestions.filter(q => !excludeQuestions.includes(q));
            const shuffled = [...availableQuestions].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        // 빠른 질문 업데이트 함수
        function updateQuickQuestions(relatedToMessage = null) {
            const quickQuestionsContainer = document.querySelector('.quick-questions');
            if (!quickQuestionsContainer) return;
            
            let newQuestions;
            if (relatedToMessage) {
                newQuestions = getRelatedQuestions(relatedToMessage, 2);
            } else {
                newQuestions = getRandomQuestions(2, currentQuestions);
            }
            
            currentQuestions = newQuestions;
            
            // 기존 버튼들 제거
            quickQuestionsContainer.innerHTML = '';
            
            // 새 버튼들 생성
            newQuestions.forEach(question => {
                const button = document.createElement('button');
                button.className = 'quick-btn';
                button.textContent = question;
                button.onclick = () => sendQuick(question);
                quickQuestionsContainer.appendChild(button);
            });
        }
        
        // 자동 스크롤 함수
        function scrollToBottom() {
            const messages = document.getElementById('chatMessages');
            messages.scrollTop = messages.scrollHeight;
        }
        
        // 부드러운 자동 스크롤 함수
        function smoothScrollToBottom() {
            const messages = document.getElementById('chatMessages');
            messages.scrollTo({
                top: messages.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // 사용자가 수동으로 스크롤했는지 감지
        function setupScrollListener() {
            const messages = document.getElementById('chatMessages');
            let isUserScrolling = false;
            
            messages.addEventListener('scroll', () => {
                const isAtBottom = messages.scrollHeight - messages.scrollTop <= messages.clientHeight + 50;
                shouldAutoScroll = isAtBottom;
            });
        }
        
        // 디바이스별 초기화
        document.addEventListener('DOMContentLoaded', function() {
            setupScrollListener(); // 스크롤 리스너 설정
            loadQuestions(); // 질문 파일 로드
            
            if (isMobile()) {
                console.log('📱 모바일 디바이스 감지');
                
                // 모바일 스크롤 최적화
                const chatMessages = document.getElementById('chatMessages');
                
                // 터치 스크롤 개선
                chatMessages.style.webkitOverflowScrolling = 'touch';
                chatMessages.style.scrollBehavior = 'smooth';
                
                // 주소창 높이 변화 대응 (iOS Safari)
                const setViewHeight = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                
                setViewHeight();
                window.addEventListener('resize', setViewHeight);
                
                // 초기 스크롤 위치 설정
                setTimeout(() => {
                    scrollToBottom();
                }, 100);
                
            } else {
                console.log('💻 데스크톱 디바이스 감지');
            }
        });

        // 빠른 질문
        function sendQuick(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        // 엔터키 처리
        function handleEnter(event) {
            if (event.key === 'Enter' && !isProcessing) {
                sendMessage();
            }
        }

        // 메시지 전송
        async function sendMessage() {
            if (isProcessing) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            isProcessing = true;
            shouldAutoScroll = true; // 새 메시지 전송 시 자동 스크롤 활성화
            input.value = '';
            document.getElementById('sendBtn').textContent = '전송중...';
            
            // 사용자 메시지 추가
            addMessage(message, 'user');
            
            // 답변과 관련된 새로운 질문으로 업데이트
            updateQuickQuestions(message);
            
            // 모바일에서 키보드 숨기기
            if (isMobile()) {
                input.blur();
            }
            
            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, chat_id: chatId })
                });

                if (!response.ok) throw new Error('서버 오류');

                // 스트림 처리
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessage = addMessage('', 'bot');
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                const content = data.choices?.[0]?.delta?.content || '';
                                if (content) {
                                    fullResponse += content;
                                    
                                    // ※ 문구 앞에 빈 줄 2개 추가 처리
                                    let displayText = fullResponse;
                                    if (displayText.includes('※ 이 답변은 AI가 안내한 내용으로')) {
                                        displayText = displayText.replace(
                                            '※ 이 답변은 AI가 안내한 내용으로', 
                                            '\n\n※ 이 답변은 AI가 안내한 내용으로'
                                        );
                                    }
                                    
                                    botMessage.querySelector('.message-content').innerHTML = displayText.replace(/\n/g, '<br>');
                                    
                                    // 실시간 자동 스크롤 (사용자가 위로 스크롤하지 않은 경우에만)
                                    if (shouldAutoScroll) {
                                        scrollToBottom();
                                    }
                                }
                            } catch (e) {}
                        }
                    }
                }

                // 답변 완료 후 관련 질문으로 다시 업데이트
                setTimeout(() => {
                    updateQuickQuestions(fullResponse || message);
                }, 500);

            } catch (error) {
                showError('연결 오류: ' + error.message);
            } finally {
                isProcessing = false;
                document.getElementById('sendBtn').textContent = '전송';
                
                // 최종 스크롤
                if (shouldAutoScroll) {
                    setTimeout(() => scrollToBottom(), 100);
                }
            }
        }

        // 메시지 추가 (개선된 버전)
        function addMessage(content, type) {
            const messages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<div class="message-content">${content}</div>`;
            messages.appendChild(div);
            
            // 자동 스크롤 (사용자가 위로 스크롤하지 않은 경우에만)
            if (shouldAutoScroll) {
                scrollToBottom();
            }
            
            return div;
        }

        // 오류 표시
        function showError(message) {
            const messages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;
            messages.appendChild(div);
            
            if (shouldAutoScroll) {
                scrollToBottom();
            }
        }
        
        // 화면 크기 변경 감지
        window.addEventListener('resize', function() {
            // 스크롤 위치 유지하되, 자동 스크롤 상태면 하단으로
            if (shouldAutoScroll) {
                setTimeout(() => scrollToBottom(), 100);
            }
        });
        
        // 모바일 키보드 대응
        if (isMobile()) {
            let initialViewportHeight = window.innerHeight;
            
            window.addEventListener('resize', function() {
                const currentHeight = window.innerHeight;
                const heightDifference = initialViewportHeight - currentHeight;
                
                // 키보드가 올라온 경우 (높이가 150px 이상 줄어든 경우)
                if (heightDifference > 150) {
                    setTimeout(() => {
                        if (shouldAutoScroll) {
                            scrollToBottom();
                        }
                    }, 300);
                }
                // 키보드가 내려간 경우
                else if (heightDifference < 50) {
                    setTimeout(() => {
                        if (shouldAutoScroll) {
                            scrollToBottom();
                        }
                    }, 100);
                }
            });
        }
    </script>J에서 가장 마지막까지 운영되는 어트랙션은 무엇인가요?",
            "USJ에서 탑승 사진은 현장에서만 구매할 수 있나요?",
            "USJ에서는 유모차를 끌고 어트랙션 대기 줄에 설 수 있나요?",
            "USJ에서 스태프에게 부탁하면 사진을 찍어주나요?",
            "USJ에서 2세 아이가 탈 수 있는 놀이기구가 있나요?",
            "USJ의 미니언 파크는 어떤 구성으로 되어 있나요?",
            "USJ에서 가성비 좋고 빨리 먹을 수 있는 식당은?",
            "USJ의 워터월드 쇼는 어떤 내용인가요?",
            "USJ에서 맨발이나 슬리퍼는 탑승에 제한이 있나요?",
            "USJ에서 당일권 없이 입장할 수 있는 방법이 있나요?",
            "USJ에서 가장 인기 있는 겨울 시즌 한정 아이템은?",
            "USJ에서 입장 후 바로 달려가야 할 어트랙션 순서는?",
            "USJ에서 하루 3끼를 모두 해결하려면 예산은 얼마나 잡아야 하나요?",
            "USJ에서 팬미팅이나 사인회 같은 이벤트도 열리나요?",
            "USJ에서 아이 분실 시 대처 방법은?",
            "USJ에서 일몰 시간대 추천 장소는 어디인가요?",
            "USJ에서 외국어 간판은 얼마나 준비되어 있나요?",
            "USJ에서 하루 종일 돌아다니면 평균 몇 보 걷나요?",
            "USJ 입장 시 QR 티켓 외에 신분증 확인도 하나요?",
            "USJ에서 직원에게 감사 표시하는 방법은?",
            "USJ는 폐장시간 이후에도 안에서 머무를 수 있나요?",
            "USJ 입장 줄은 보통 얼마나 걸리나요?",
            "USJ에서 체온 측정은 여전히 하나요?",
            "USJ에서 가장 많은 시간을 소비하게 되는 구역은 어디인가요?",
            "USJ에서 주차 요금은 얼마인가요?",
            "USJ에서 대기 시간 줄이는 팁이 있다면?",
            "USJ에서 미성년자는 단독 입장 가능한가요?",
            "USJ에서 일본 내 휴대폰 개통 서비스가 있나요?",
            "USJ에 비상 상황 발생 시 어떻게 안내를 받나요?",
            "USJ 파크 주변에 야경 명소는 어디인가요?",
            "USJ는 촬영용 드론 반입이 가능한가요?",
            "USJ의 전 구역을 모두 둘러보는 데 필요한 최소 시간은?",
            "USJ에서 맥주나 주류는 어디서 구매 가능한가요?",
            "USJ는 방문 날짜에 따라 티켓 가격이 다른가요?",
            "USJ에서 종교 기도 공간이 있나요?",
            "USJ에서 분실물을 찾지 못한 경우 나중에 어떻게 확인하나요?",
            "USJ에는 24시간 운영되는 공간이 있나요?",
            "USJ에서 생일인 사람에게는 어떤 혜택이 있나요?",
            "USJ에서 아이가 울거나 지치면 쉴 수 있는 공간은 어디인가요?",
            "USJ에서의 퍼레이드는 하루 몇 번 진행되나요?",
            "USJ 기념품 중 유통기한이 긴 간식류는 어떤 게 있나요?",
            "USJ에는 음료를 리필해주는 시스템이 있나요?",
            "USJ에서 가장 늦게까지 운영하는 푸드 매장은 어디인가요?",
            "USJ에서 체험용 코스튬 대여는 가능한가요?",
            "USJ에서 동전 없는 무현금 결제는 완전히 가능한가요?",
            "USJ에서 유모차 대여 시 미리 예약 가능한가요?",
            "USJ에서 분수 쇼나 물놀이 이벤트는 어디서 하나요?",
            "USJ에 반입 가능한 음식물의 기준은 무엇인가요?",
            "USJ에서 실외 대기 줄의 그늘 대책은 어떻게 해야 하나요?",
            "USJ에서 할로윈 코스튬 착용 시 주의할 점은?",
            "USJ에서 개인 휠체어를 가져가는 것은 괜찮은가요?",
            "USJ에서 어린이를 잃어버렸을 때는 어디로 가야 하나요?",
            "USJ에서 한국어가 가능한 직원은 어떻게 찾을 수 있나요?",
            "USJ 입장권을 투어비스에서 구매하면 다른 점이 있나요?",
            "USJ 입장 후 바로 사진 촬영하기 좋은 스팟은?",
            "USJ는 어떤 방식으로 수하물 보관 서비스를 제공하나요?",
            "USJ에서 종일 우비를 입고 다녀도 괜찮나요?",
            "USJ는 몇 개 국어 안내가 가능한가요?",
            "USJ에서 어트랙션을 빠르게 돌려면 몇 개까지 가능할까요?",
            "USJ 근처 숙소 중 가성비 좋은 곳은 어디인가요?",
            "USJ에서 출국 전 기념품 쇼핑만 하려면 어디가 좋나요?",
            "USJ에서 주차 공간은 예약할 수 있나요?",
            "USJ 파크 안에서 가장 저렴한 기념품은 무엇인가요?",
            "USJ에는 영화관이나 VR 체험 공간도 있나요?",
            "USJ에서 현장 결제만 가능한 서비스가 있나요?",
            "USJ에서 정문까지 가장 빨리 이동하는 지하철 출구는?",
            "USJ에 입장하지 않고도 쇼핑 가능한 곳이 있나요?",
            "USJ의 퍼레이드는 비상시에 중단될 수 있나요?",
            "USJ는 왜 특정 어트랙션을 조기 마감하나요?",
            "USJ에서 커플 여행자에게 추천하는 코스는?",
            "USJ에서 병원이나 약국은 어떻게 이용하나요?",
            "USJ에서는 음식물 알레르기를 어떻게 확인하나요?",
            "USJ에서 어린이 캐릭터 포토타임은 어디서 하나요?",
            "USJ에는 야외 공연 외에도 실내 극장이 있나요?",
            "USJ는 오픈런이 필요한 날이 따로 있나요?",
            "USJ에 입장 후 가장 먼저 할 일은 무엇인가요?",
            "USJ 안에서 프린팅 서비스는 있나요?",
            "USJ에서 외국인 관광객을 위한 특별 이벤트가 있나요?",
            "USJ에서 제일 붐비지 않는 어트랙션은?",
            "USJ에는 24개월 미만 유아가 즐길 수 있는 콘텐츠가 있나요?",
            "USJ 퇴장 후 바로 공항으로 이동 가능한가요?",
            "USJ에서 오후에 입장하면 인기 어트랙션 이용이 가능한가요?",
            "USJ에서 가족사진을 공식 포토그래퍼가 찍어주나요?",
            "USJ에서는 학생 단체 방문 시 어떤 할인이나 서비스가 있나요?",
            "USJ의 공식 앱은 한국에서 미리 설치할 수 있나요?",
            "USJ의 티켓 가격은 실시간으로 변동되나요?",
            "USJ에서 한국인 관광객 비중이 높은 구역은 어디인가요?",
            "USJ에서 파크 내 물가는 일본 평균보다 비싼 편인가요?",
            "USJ 입장 전 외부에서 식사를 해결할 수 있는 곳은?",
            "USJ에서는 하루 중 언제가 가장 덜 붐비나요?",
            "USJ에서 트롤리 캐리어 반입이 가능한가요?",
            "USJ의 시즌별 주요 이벤트는 어디서 확인하나요?",
            "USJ 내부에서 맥북이나 노트북 사용이 가능한 공간은?",
            "USJ 파크 내에서 가장 조용한 장소는 어디인가요?",
            "USJ에서 실외 대기 줄이 불편할 경우 쉴 수 있는 팁은?",
            "USJ에서 개인 촬영 장비 사용에 제한이 있나요?",
            "USJ에서 앱 없이도 이동이 수월한가요?",
            "USJ에서 가장 많이 팔리는 캐릭터 굿즈는 어떤 게 있나요?",
            "USJ에서 '싱글 라이더' 제도는 누구나 이용할 수 있나요?",
            "USJ에서 휴대폰 충전이 급할 때 대처법은?",
            "USJ의 연간 패스는 어떤 사람들이 가장 유리할까요?",
            "USJ에서 휠체어 대여 시 신분증이 꼭 필요한가요?",
            "USJ에서 가장 기념품이 다양하게 있는 매장은 어디인가요?",
            "USJ에서 실제 영화 촬영 소품과 유사한 전시물이 있나요?",
            "USJ 어트랙션 중 비오는 날에도 운영하는 곳은 어디인가요?",
            "USJ에 반려동물 보호용 시설은 없나요?",
            "USJ에서 퇴장 후 다시 입장하고 싶은 경우, 어떻게 해야 하나요?",
            "USJ 어트랙션 중 좌석이 넓은 편인 기종은 어떤 건가요?",
            "USJ에서 오픈런 시 입장 대기 시간은 어느 정도인가요?",
            "USJ의 공식 파트너 호텔을 이용하면 혜택이 있나요?",
            "USJ에서 쇼핑한 물건을 택배로 한국까지 보내줄 수 있나요?",
            "USJ의 '마리오 카트' 어트랙션은 어린이도 탈 수 있나요?",
            "USJ에서 가장 포토존이 많은 장소는 어디인가요?",
            "USJ에서 종이 지도를 받을 수 있나요?",
            "USJ에서 카드 결제 후 환불은 어떤 방식으로 되나요?",
            "USJ에서는 수유실이 몇 곳 있나요?",
            "USJ에서 아이가 놀다 넘어졌을 때 처치는 어디서 하나요?",
            "USJ에서는 어트랙션 운휴 정보를 어디서 확인하나요?",
            "USJ에서 이모티콘 굿즈도 판매하나요?",
            "USJ에서 결제한 영수증은 세금환급에 사용할 수 있나요?",
            "USJ 내에서 손 씻을 수 있는 곳은 자주 보이나요?",
            "USJ 입장 전 대기 중 우천 시 피할 곳이 있나요?",
            "USJ의 퍼레이드 중 캐릭터가 직접 손 흔들어주는 구역은?",
            "USJ에서 하루 일정 중 마무리로 추천하는 콘텐츠는?",
            "USJ에서 각 어트랙션별로 제공되는 안내 언어는?",
            "USJ에서 미성년자의 야간 입장은 제한되나요?",
            "USJ 입장 전 짐이 많을 경우 해결 방법은?",
            "USJ에서 스탬프 투어나 체크포인트 이벤트는 어떻게 참여하나요?",
            "USJ에서 휴대폰 데이터 부족 시 어떤 선택이 있나요?",
            "USJ의 레스토랑 예약은 어떻게 하나요?",
            "USJ에서 가장 많이 줄을 서는 기념품은 무엇인가요?",
            "USJ에서는 QR 입장권 외에 실물 티켓도 주나요?",
            "USJ의 포토북 제작 서비스는 어떤 방식인가요?",
            "USJ에서 모바일 티켓이 인식 안 될 경우 대처법은?",
            "USJ 입구에서 가장 가까운 편의점은 어디인가요?",
            "USJ에서 계절 이벤트 스케줄은 언제부터 공개되나요?",
            "USJ에서 대기 시간 없는 어트랙션이 존재하나요?",
            "USJ의 셀프 포토 부스는 어디에 위치하나요?",
            "USJ에서 타인과 줄을 서다가 자리 바꾸는 것이 허용되나요?",
            "USJ에서 가장 여유로운 시간대는 언제인가요?",
            "USJ에서 일반 대기줄과 익스프레스 줄은 어떻게 구분하나요?",
            "USJ에서 사진 인화 서비스는 어디서 받을 수 있나요?",
            "USJ에는 키즈용 놀이기구 외에 교육적인 콘텐츠도 있나요?",
            "USJ 내 이동 시 휠체어나 유모차의 동선은 원활한가요?",
            "USJ에서 미니언 파크는 언제가 가장 덜 붐비나요?",
            "USJ 어트랙션 중 몸무게 제한이 있는 곳이 있나요?",
            "USJ에서는 외국인 관광객 전용 혜택이 따로 있나요?",
            "USJ의 해리포터 존에서 마법 지팡이 체험은 유료인가요?",
            "USJ에서 스낵바 대신 푸드트럭은 어디에서 보이나요?",
            "USJ에서 소지품을 안전하게 맡길 수 있는 방법은?",
            "USJ 앱에서 대기 시간 정보는 얼마나 자주 갱신되나요?",
            "USJ 어트랙션의 평균 대기 시간은 얼마나 되나요?",
            "USJ에서 입장권 없이 파크 분위기를 느낄 수 있는 곳은?",
            "USJ 기념품은 시즌마다 완전히 바뀌나요?",
            "USJ에서 현지인과 외국인의 비율은 대체로 어떤가요?",
            "USJ는 우천 시에도 폐장하지 않나요?",
            "USJ에서 마이보틀을 가져가면 활용할 수 있나요?",
            "USJ는 입장권 외에 현장에서 추가 비용이 많이 드나요?",
            "USJ의 파크 내에서 가장 인스타그램 사진이 잘 나오는 곳은?",
            "USJ에서는 실시간 이벤트 정보 방송이 자주 있나요?",
            "USJ 내에서 외부 배달음식 수령이 가능한가요?",
            "USJ에서 모임이나 단체 행사를 할 수 있는 공간이 있나요?",
            "USJ에서 비상시 대피는 어떻게 이루어지나요?",
            "USJ에서 가장 피로를 덜 느끼는 동선은 어떻게 짜야 하나요?",
            "USJ에서 직원들이 즉석에서 응대해주는 특이한 서비스가 있나요?",
            "USJ에서 음식물 쓰레기나 일반 쓰레기는 어떻게 처리하나요?",
            "USJ에서 익스프레스 패스 없이도 짧은 시간에 만족할 수 있는 코스는?",
            "USJ에서 날씨에 따라 준비해야 할 물품 추천은?",
            "USJ에서 한국어가 통하지 않는 경우 어떻게 대처하나요?",
            "USJ를 재방문할 가치가 있는 이유는 뭔가요?",
            "1일권과 다일권 종류가 뭐가 있나요?",
            "트와일라잇 패스(Twilight Pass)란 무엇인가요?",
            "장애인 할인 티켓은 어떻게 되나요?",
            "어린이·청소년·시니어 요금 기준은 어떻게 되나요?",
            "생일 할인 있나요?",
            "생일 월에 몇 % 할인되나요?",
            "티켓은 얼마나 빨리 매진되나요?",
            "미리 사야 하나요?",
            "현장 구입 가능한가요?",
            "입장권 판매 마감 시점은 언제인가요?",
            "'파크 교환권'은 무엇인가요?",
            "특급 호텔 패키지 티켓 특징은?",
            "공식 대리점과 차이가 있나요?",
            "공식 웹사이트에서만 팔죠?",
            "티켓 구매 후 환불 가능한가요?",
            "구매 후 이름 변경 가능할까요?",
            "비상 상황 시 보험 적용되나요?",
            "QR 티켓과 종이 티켓 차이 설명해주세요.",
            "다이렉트 인(Direct In)이란?",
            "그룹 구매 시 티켓 공유 가능한가요?",
            "가족 한 번에 구매 가능?",
            "모바일 미소지 시 어떻게 하죠?",
            "해외 결제 수수료 있나요?",
            "국제 전화 오류 시 어떻게 문의해요?",
            "입장권 취소 정책은 어떻게 되나요?",
            "특별 할인(학생, 단체) 있나요?",
            "일본 내 여행사 예약과 차이점은?",
            "어린이 기준 연령은 몇 살인가요?",
            "파크 내 재입장 가능한가요?",
            "비 오는 날 입장권은 유효한가요?",
            "입장권 기프트 카드 같은 게 있나요?",
            "후불 결제 가능한가요?",
            "결제 오류 발생하면?",
            "확인 메일이 안 왔어요.",
            "티켓 구매 영수증 재발급 가능한가요?",
            "애뉴얼 패스(연간권)란 뭔가요?",
            "연간권 혜택은 무엇인가요?",
            "연간권 재발급 가능?",
            "연간권 QR 공유 가능한가요?",
            "연간권은 몇 종류인가요?",
            "슈퍼 닌텐도 월드 타임드 엔트리란?",
            "해리포터 월드 타임드 엔트리란?",
            "어떻게 받을 수 있나요?",
            "현장 배포는 언제 시작하나요?",
            "모바일 앱으로 추첨 가능한가요?",
            "Express Pass에 포함되나요?",
            "단순 타임드 엔트리만 구매 가능한가요?",
            "타임드 엔트리 없으면 못 들어가나요?",
            "지정 시간 외 입장 가능한가요?",
            "환불은 어떻게 되나요?",
            "Express Pass 구매 시 함께 줘요?",
            "예매 가능한 시기는?",
            "당일 현장 신청 가능할까요?",
            "당일 발매량은 어느 정도인가요?",
            "추첨 당첨 기준은?",
            "동반자는 함께 들어갈 수 있나요?",
            "타임 슬롯 변경 가능한가요?",
            "늦게 가면 입장 못 하나요?",
            "캐리어 입장시간은?",
            "종료 시간은 언제인가요?",
            "어떤 종류가 있나요?",
            "Express Pass 4와 7의 차이는?",
            "시간 지정 방식은 어떻게 되나요?",
            "소요 시간 당일 배정받나요?",
            "Express 없이 가능한가요?",
            "Express Pass만 구매하면 Studio Pass 필요 없는가요?",
            "Super Nintendo 포함한 패스는?",
            "늦게 사용해도 되나요?",
            "추가 비용 발생하나요?",
            "Express Pass 구매 방법은?",
            "모바일 QR로 사용 가능한가요?",
            "중고 Express Pass 사용 가능한가요?",
            "무제한 사용 모델은 있나요?",
            "Express Pass 환불 가능한가요?",
            "Express 패스 배포량은?",
            "성수기와 비수기에 가격 차이 있나요?",
            "당일 현장 판매하나요?",
            "VIP 패스와 차이점은?",
            "VIP 패스 보장은 어떤가요?",
            "Express 외에 이용 가능한 방식은?",
            "택배 배송은 언제 도착하나요?",
            "모바일/인쇄 두 가지 방식 중 추천은?",
            "분실 시 재발급 가능하나요?",
            "가족분께 전달하는 법은?",
            "해외 프린터에서 인쇄 가능한가요?",
            "QR코드가 인쇄 안 돼요",
            "입장 게이트에서 오류 날 경우?",
            "스마트폰 화면만으로 충분한가요?",
            "기기 꺼졌을 때 어떻게 하나요?",
            "기프트 티켓 사용법은?",
            "현지 호텔에서 받을 수 있나요?",
            "호텔 카운터에서 교환 가능한가요?",
            "공식 앱에서 확인 가능하나요?",
            "재입장 시 스탬프 필요하나요?",
            "게스트 정보 수정 가능한가요?",
            "어린이만 따로 입장 가능한가요?",
            "단체 입장 절차는?",
            "스튜디오 패스 유효 시간대는?",
            "연간권 등록 방식은?",
            "티켓 분실 시 입장 가능할까요?",
            "유니버설 스튜디오 재팬이 무엇인가요? 롯데월드 같은 놀이공원인가요?",
            "유니버셜 스튜디오 재팬 가려는데 뭐 사야 되나요",
            "입장권 구입",
            "앱등록",
            "날짜변경",
            "구매가능시기",
            "연령 확인",
            "입장권의 티켓코드가 동일한데 문제없나요",
            "이름 칸이 비어있는데 문제 없나요",
            "만 12세 초등학생 소인권 구매 가능?",
            "1.5일권 또는 2일권 구입시 몇일 기준으로 구입해야 할까요?",
            "익스프레스?",
            "이용방법",
            "날짜, 종류, 시간 변경",
            "시간 지정 어트랙션의 이용 시간 변경",
            "시간 미지정 어트랙션",
            "입장권 포함 여부",
            "어트랙션이 운행 안할 경우",
            "재고 추가",
            "어린이 이용 시 (신장제한등)",
            "얼리파크인 티켓 소개",
            "입장 시간은 어떻게 아나요?",
            "재고한정, 선착순예약",
            "구매 후 바우처 이용",
            "닌텐도 월드 들어가려면 어떡하나요",
            "재입장 가능한가요?",
            "바우처 확인 방법",
            "바우처 사용 방법",
            "꼭 출력해야하나요?",
            "취소 가능한가요?"
        ];
        
        // 현재 표시된 질문들을 저장할 배열
        let currentQuestions = [];
        
        // 질문과 관련 키워드 매핑
        const questionKeywords = {
            "마리오": ["마리오", "닌텐도", "Nintendo", "카트", "게임"],
            "캐리어": ["캐리어", "짐", "수하물", "보관", "락커"],
            "해리포터": ["해리포터", "포터", "마법", "호그와트", "지팡이"],
            "어린이": ["어린이", "아이", "아기", "유아", "키즈", "가족"],
            "식당": ["식당", "음식", "식사", "레스토랑", "메뉴"],
            "입장권": ["입장권", "티켓", "패스", "구매", "예약"],
            "교통": ["교통", "지하철", "전철", "이동", "역"],
            "물": ["물", "음료", "마실", "정수기"],
            "분실": ["분실", "잃어버리", "찾기"],
            "굿즈": ["굿즈", "기념품", "상품", "쇼핑"],
            "익스프레스": ["익스프레스", "Express", "패스", "우선"],
            "애완동물": ["애완동물", "반려동물", "펫", "개", "고양이"],
            "촬영": ["촬영", "사진", "카메라", "포토"],
            "충전": ["충전", "배터리", "전기"],
            "퍼레이드": ["퍼레이드", "쇼", "공연"],
            "대기": ["대기", "줄", "시간", "기다리"],
            "캐릭터": ["캐릭터", "미니언", "스누피"],
            "영어": ["영어", "언어", "외국어"],
            "혼자": ["혼자", "싱글", "1인"],
            "시티워크": ["시티워크", "CityWalk", "외부"],
            "알레르기": ["알레르기", "음식", "식단"],
            "앱": ["앱", "어플", "어플리케이션"],
            "ATM": ["ATM", "현금", "돈"],
            "우산": ["우산", "비", "우천"],
            "할인": ["할인", "외국인", "할인"],
            "교통카드": ["교통카드", "IC카드", "ICOCA"],
            "생일": ["생일", "생일", "이벤트"],
            "싱글라이더": ["싱글라이더", "1인", "혼자"],
            "호텔": ["호텔", "숙소", "숙박"],
            "무서운": ["무서운", "무서", "롤러코스터"],
            "외국인": ["외국인", "해외", "관광객"],
            "환전": ["환전", "환전", "돈"],
            "술": ["술", "맥주", "알코올"],
            "검사": ["검사", "짐검사", "보안"],
            "키제한": ["키제한", "신장", "키"],
            "주차": ["주차", "주차장", "차"],
            "VR": ["VR", "가상현실"],
            "연중무휴": ["연중무휴", "휴장", "운영"],
            "코인락커": ["코인락커", "락커"],
            "기념품": ["기념품", "굿즈", "쇼핑"],
            "정확": ["정확", "앱", "대기시간"],
            "현금": ["현금", "카드", "결제"],
            "운영시간": ["운영시간", "시간", "폐장"],
            "스마트폰": ["스마트폰", "폰", "휴대폰"],
            "드론": ["드론", "촬영"],
            "은행": ["은행", "ATM"],
            "현장구매": ["현장구매", "당일", "티켓"],
            "와이파이": ["와이파이", "WiFi", "인터넷"],
            "비": ["비", "우천", "날씨"],
            "날짜변경": ["날짜변경", "변경", "티켓"],
            "수유실": ["수유실", "아기", "수유"],
            "온라인": ["온라인", "인터넷", "구매"],
            "확약권": ["확약권", "입장권", "닌텐도"],
            "야간권": ["야간권", "저녁", "입장"],
            "휠체어": ["휠체어", "장애인"],
            "택배": ["택배", "배송"],
            "우비": ["우비", "비", "비옷"],
            "이벤트": ["이벤트", "시즌"],
            "콜라보": ["콜라보", "애니메이션"],
            "파티": ["파티", "생일"],
            "기저귀": ["기저귀", "아기"],
            "게임": ["게임", "부스"],
            "개장": ["개장", "오픈", "시간"],
            "렌즈": ["렌즈", "카메라"],
            "편의점": ["편의점", "구매"],
            "반입금지": ["반입금지", "금지", "물품"],
            "연간권": ["연간권", "패스"],
            "왕복": ["왕복", "여행"],
            "인쇄": ["인쇄", "출력"],
            "유모차": ["유모차", "아기"],
            "환불": ["환불", "취소"],
            "혼잡": ["혼잡", "붐비", "시간대"],
            "응급": ["응급", "의료", "병원"],
            "결제": ["결제", "카드", "현금"],
            "외국어": ["외국어", "안내"],
            "디저트": ["디저트", "간식"],
            "데이터": ["데이터", "통신"],
            "재판매": ["재판매", "중고"],
            "휴식": ["휴식", "쉬기"],
            "확인": ["확인", "체크"],
            "적합": ["적합", "어린이"],
            "캐릭터식당": ["캐릭터식당", "식당"],
            "가족": ["가족", "단위"],
            "포토패스": ["포토패스", "사진"],
            "할로윈": ["할로윈", "이벤트"],
            "신발": ["신발", "운동화"],
            "저녁": ["저녁", "야간"],
            "포토스팟": ["포토스팟", "사진"],
            "장애인": ["장애인", "서비스"],
            "계절": ["계절", "시즌"],
            "QR": ["QR", "코드"],
            "예약": ["예약", "레스토랑"],
            "멀미": ["멀미", "어지러움"],
            "마스크": ["마스크", "착용"],
            "저렴": ["저렴", "싸다"],
            "콘센트": ["콘센트", "충전"],
            "스탬프": ["스탬프", "도장"],
            "멀티탭": ["멀티탭", "전기"],
            "한국어": ["한국어", "방송"],
            "화장실": ["화장실", "급함"],
            "교대": ["교대", "차일드스위치"],
            "금속탐지기": ["금속탐지기", "검사"],
            "마지막": ["마지막", "운영"],
            "탑승사진": ["탑승사진", "구매"],
            "스태프": ["스태프", "직원"],
            "2세": ["2세", "어린이"],
            "미니언": ["미니언", "파크"],
            "패스트푸드": ["패스트푸드", "빠른"],
            "워터월드": ["워터월드", "쇼"],
            "슬리퍼": ["슬리퍼", "신발"],
            "겨울": ["겨울", "시즌"],
            "순서": ["순서", "코스"],
            "예산": ["예산", "비용"],
            "팬미팅": ["팬미팅", "이벤트"],
            "분실": ["분실", "아이"],
            "일몰": ["일몰", "야경"],
            "간판": ["간판", "언어"],
            "걷기": ["걷기", "보행"],
            "신분증": ["신분증", "확인"],
            "감사": ["감사", "직원"],
            "폐장": ["폐장", "시간"],
            "입장줄": ["입장줄", "대기"],
            "체온": ["체온", "측정"],
            "소비": ["소비", "시간"],
            "주차요금": ["주차요금", "요금"],
            "팁": ["팁", "조언"],
            "미성년자": ["미성년자", "단독"],
            "휴대폰": ["휴대폰", "개통"],
            "비상": ["비상", "상황"],
            "야경": ["야경", "명소"],
            "최소시간": ["최소시간", "시간"],
            "가격": ["가격", "변동"],
            "기도": ["기도", "종교"],
            "24시간": ["24시간", "운영"],
            "퍼레이드횟수": ["퍼레이드", "횟수"],
            "유통기한": ["유통기한", "간식"],
            "리필": ["리필", "음료"],
            "푸드매장": ["푸드매장", "운영"],
            "코스튬": ["코스튬", "대여"],
            "무현금": ["무현금", "결제"],
            "분수": ["분수", "쇼"],
            "음식물": ["음식물", "반입"],
            "그늘": ["그늘", "대책"],
            "할로윈코스튬": ["할로윈", "코스튬"],
            "개인휠체어": ["개인", "휠체어"],
            "어린이분실": ["어린이", "분실"],
            "한국어직원": ["한국어", "직원"],
            "투어비스": ["투어비스", "구매"],
            "포토그래퍼": ["포토그래퍼", "사진"],
            "학생단체": ["학생", "단체"],
            "설치": ["설치", "앱"],
            "실시간": ["실시간", "변동"],
            "한국인": ["한국인", "관광객"],
            "물가": ["물가", "비싸다"],
            "식사": ["식사", "외부"],
            "덜붐비": ["덜붐비", "시간"],
            "캐리어반입": ["캐리어", "반입"],
            "시즌이벤트": ["시즌", "이벤트"],
            "노트북": ["노트북", "사용"],
            "조용": ["조용", "장소"],
            "촬영장비": ["촬영", "장비"],
            "싱글라이더": ["싱글라이더", "제도"],
            "연간패스": ["연간", "패스"],
            "신분증필요": ["신분증", "필요"],
            "기념품매장": ["기념품", "매장"],
            "영화소품": ["영화", "소품"],
            "반려동물": ["반려동물", "시설"],
            "좌석": ["좌석", "넓다"],
            "오픈런": ["오픈런", "대기"],
            "파트너호텔": ["파트너", "호텔"],
            "한국배송": ["한국", "배송"],
            "어린이탑승": ["어린이", "탑승"],
            "포토존": ["포토존", "장소"],
            "종이지도": ["종이", "지도"],
            "카드환불": ["카드", "환불"],
            "수유실개수": ["수유실", "개수"],
            "넘어짐": ["넘어짐", "처치"],
            "운휴정보": ["운휴", "정보"],
            "이모티콘": ["이모티콘", "굿즈"],
            "세금환급": ["세금", "환급"],
            "손씻기": ["손씻기", "위생"],
            "우천대기": ["우천", "대기"],
            "손흔들기": ["손흔들기", "캐릭터"],
            "마무리": ["마무리", "추천"],
            "안내언어": ["안내", "언어"],
            "야간입장": ["야간", "입장"],
            "짐많음": ["짐", "많음"],
            "스탬프투어": ["스탬프", "투어"],
            "데이터부족": ["데이터", "부족"],
            "레스토랑예약": ["레스토랑", "예약"],
            "줄서는기념품": ["줄", "기념품"],
            "실물티켓": ["실물", "티켓"],
            "포토북": ["포토북", "제작"],
            "티켓인식": ["티켓", "인식"],
            "편의점": ["편의점", "가까운"],
            "계절스케줄": ["계절", "스케줄"],
            "대기시간없음": ["대기시간", "없음"],
            "셀프포토": ["셀프", "포토"],
            "자리바꾸기": ["자리", "바꾸기"],
            "여유시간": ["여유", "시간"],
            "대기줄구분": ["대기줄", "구분"],
            "사진인화": ["사진", "인화"],
            "교육콘텐츠": ["교육", "콘텐츠"],
            "동선": ["동선", "이동"],
            "미니언시간": ["미니언", "시간"],
            "몸무게제한": ["몸무게", "제한"],
            "외국인혜택": ["외국인", "혜택"],
            "마법지팡이": ["마법", "지팡이"],
            "푸드트럭": ["푸드트럭", "위치"],
            "소지품보관": ["소지품", "보관"],
            "갱신주기": ["갱신", "주기"],
            "평균대기": ["평균", "대기"],
            "외부분위기": ["외부", "분위기"],
            "시즌변화": ["시즌", "변화"],
            "비율": ["비율", "현지인"],
            "우천운영": ["우천", "운영"],
            "마이보틀": ["마이보틀", "활용"],
            "추가비용": ["추가", "비용"],
            "인스타그램": ["인스타그램", "사진"],
            "실시간방송": ["실시간", "방송"],
            "배달음식": ["배달", "음식"],
            "단체행사": ["단체", "행사"],
            "비상대피": ["비상", "대피"],
            "피로감소": ["피로", "감소"],
            "즉석서비스": ["즉석", "서비스"],
            "쓰레기처리": ["쓰레기", "처리"],
            "짧은코스": ["짧은", "코스"],
            "날씨준비": ["날씨", "준비"],
            "한국어소통": ["한국어", "소통"],
            "재방문": ["재방문", "가치"]
        };
        
        // 랜덤 질문 선택 함수
        function getRandomQuestions(count = 2, excludeQuestions = []) {
            const availableQuestions = usjQuestions.filter(q => !excludeQuestions.includes(q));
            const shuffled = availableQuestions.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        // 관련 질문 찾기 함수
        function getRelatedQuestions(userMessage, count = 2) {
            const relatedQuestions = [];
            const messageWords = userMessage.toLowerCase();
            
            // 키워드 기반으로 관련 질문 찾기
            for (const question of usjQuestions) {
                for (const [keyword, synonyms] of Object.entries(questionKeywords)) {
                    if (synonyms.some(synonym => messageWords.includes(synonym.toLowerCase()))) {
                        if (question.toLowerCase().includes(keyword) && 
                            !relatedQuestions.includes
        
        // 자동 스크롤 함수
        function scrollToBottom() {
            const messages = document.getElementById('chatMessages');
            messages.scrollTop = messages.scrollHeight;
        }
        
        // 부드러운 자동 스크롤 함수
        function smoothScrollToBottom() {
            const messages = document.getElementById('chatMessages');
            messages.scrollTo({
                top: messages.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // 사용자가 수동으로 스크롤했는지 감지
        function setupScrollListener() {
            const messages = document.getElementById('chatMessages');
            let isUserScrolling = false;
            
            messages.addEventListener('scroll', () => {
                const isAtBottom = messages.scrollHeight - messages.scrollTop <= messages.clientHeight + 50;
                shouldAutoScroll = isAtBottom;
            });
        }
        
        // 디바이스별 초기화
        document.addEventListener('DOMContentLoaded', function() {
            setupScrollListener(); // 스크롤 리스너 설정
            
            if (isMobile()) {
                console.log('📱 모바일 디바이스 감지');
                
                // 모바일 스크롤 최적화
                const chatMessages = document.getElementById('chatMessages');
                
                // 터치 스크롤 개선
                chatMessages.style.webkitOverflowScrolling = 'touch';
                chatMessages.style.scrollBehavior = 'smooth';
                
                // 주소창 높이 변화 대응 (iOS Safari)
                const setViewHeight = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                
                setViewHeight();
                window.addEventListener('resize', setViewHeight);
                
                // 초기 스크롤 위치 설정
                setTimeout(() => {
                    scrollToBottom();
                }, 100);
                
            } else {
                console.log('💻 데스크톱 디바이스 감지');
            }
        });

        // 빠른 질문
        function sendQuick(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        // 엔터키 처리
        function handleEnter(event) {
            if (event.key === 'Enter' && !isProcessing) {
                sendMessage();
            }
        }

        // 메시지 전송
        async function sendMessage() {
            if (isProcessing) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            isProcessing = true;
            shouldAutoScroll = true; // 새 메시지 전송 시 자동 스크롤 활성화
            input.value = '';
            document.getElementById('sendBtn').textContent = '전송중...';
            
            // 사용자 메시지 추가
            addMessage(message, 'user');
            
            // 모바일에서 키보드 숨기기
            if (isMobile()) {
                input.blur();
            }
            
            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, chat_id: chatId })
                });

                if (!response.ok) throw new Error('서버 오류');

                // 스트림 처리
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessage = addMessage('', 'bot');
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                const content = data.choices?.[0]?.delta?.content || '';
                                if (content) {
                                    fullResponse += content;
                                    
                                    // ※ 문구 앞에 빈 줄 2개 추가 처리
                                    let displayText = fullResponse;
                                    if (displayText.includes('※ 이 답변은 AI가 안내한 내용으로')) {
                                        displayText = displayText.replace(
                                            '※ 이 답변은 AI가 안내한 내용으로', 
                                            '\n\n※ 이 답변은 AI가 안내한 내용으로'
                                        );
                                    }
                                    
                                    botMessage.querySelector('.message-content').innerHTML = displayText.replace(/\n/g, '<br>');
                                    
                                    // 실시간 자동 스크롤 (사용자가 위로 스크롤하지 않은 경우에만)
                                    if (shouldAutoScroll) {
                                        scrollToBottom();
                                    }
                                }
                            } catch (e) {}
                        }
                    }
                }

            } catch (error) {
                showError('연결 오류: ' + error.message);
            } finally {
                isProcessing = false;
                document.getElementById('sendBtn').textContent = '전송';
                
                // 최종 스크롤
                if (shouldAutoScroll) {
                    setTimeout(() => scrollToBottom(), 100);
                }
            }
        }

        // 메시지 추가 (개선된 버전)
        function addMessage(content, type) {
            const messages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<div class="message-content">${content}</div>`;
            messages.appendChild(div);
            
            // 자동 스크롤 (사용자가 위로 스크롤하지 않은 경우에만)
            if (shouldAutoScroll) {
                scrollToBottom();
            }
            
            return div;
        }

        // 오류 표시
        function showError(message) {
            const messages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;
            messages.appendChild(div);
            
            if (shouldAutoScroll) {
                scrollToBottom();
            }
        }
        
        // 화면 크기 변경 감지
        window.addEventListener('resize', function() {
            // 스크롤 위치 유지하되, 자동 스크롤 상태면 하단으로
            if (shouldAutoScroll) {
                setTimeout(() => scrollToBottom(), 100);
            }
        });
        
        // 모바일 키보드 대응
        if (isMobile()) {
            let initialViewportHeight = window.innerHeight;
            
            window.addEventListener('resize', function() {
                const currentHeight = window.innerHeight;
                const heightDifference = initialViewportHeight - currentHeight;
                
                // 키보드가 올라온 경우 (높이가 150px 이상 줄어든 경우)
                if (heightDifference > 150) {
                    setTimeout(() => {
                        if (shouldAutoScroll) {
                            scrollToBottom();
                        }
                    }, 300);
                }
                // 키보드가 내려간 경우
                else if (heightDifference < 50) {
                    setTimeout(() => {
                        if (shouldAutoScroll) {
                            scrollToBottom();
                        }
                    }, 100);
                }
            });
        }
    </script>
</body>
</html>
